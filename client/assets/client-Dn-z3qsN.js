import{a as g}from"./axios-NIGUFBhG.js";import{j as d}from"./jwt-decode-VWaDGczM.js";const i="access_token",c="access_token_exp",w=3e4;function S(e){const t=d(e);t.exp&&(localStorage.setItem(i,e),localStorage.setItem(c,(t.exp*1e3).toString()))}function m(){return localStorage.getItem(i)}function k(){const e=localStorage.getItem(c);if(!e)return null;const t=parseInt(e,10);return isNaN(t)?null:t}function l(){localStorage.removeItem(i),localStorage.removeItem(c)}async function C(e,t){const n=await f.post("/login_check",{username:e,password:t},{withCredentials:!0});S(n.data.token)}async function p(){try{const e=await f.post("/token/refresh",{},{withCredentials:!0});return S(e.data.token),e.data.token}catch{return l(),null}}function T(){l(),f.post("/token/invalidate",{},{withCredentials:!0}).catch(()=>{})}async function _(){const e=localStorage.getItem(i),t=localStorage.getItem(c);if(!e||!t)return null;const n=parseInt(t,10);if(isNaN(n))return null;const s=Date.now();if(n-s>w)return e;const o=await p();return o||(l(),null)}const f=g.create({baseURL:"https://fsa.su/api",headers:{"Content-Type":"application/json"},withCredentials:!0}),r=g.create({baseURL:"https://fsa.su/api",headers:{"Content-Type":"application/json"},withCredentials:!0}),A=30*1e3;r.interceptors.request.use(async e=>{let t=m();const n=k();if(t&&n){const s=Date.now();n-s<A&&(t=await p())}return t&&(e.headers.Authorization=`Bearer ${t}`),e});let a=!1,u=[];const h=(e,t=null)=>{u.forEach(n=>{e?n.reject(e):n.resolve(t)}),u=[]};r.interceptors.response.use(e=>e,async e=>{const t=e.config;if(e.response?.status===401&&!t._retry){if(a)return new Promise((s,o)=>{u.push({resolve:s,reject:o})}).then(s=>(s&&(t.headers.Authorization="Bearer "+s),r(t)));t._retry=!0,a=!0;const n=await p();return n?(h(null,n),a=!1,t.headers.Authorization="Bearer "+n,r(t)):(a=!1,h(e,null),Promise.reject(e))}return Promise.reject(e)});export{r as a,T as b,m as g,_ as i,C as l};
